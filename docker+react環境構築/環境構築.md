# 環境構築

## ゴール

dockerでReactの開発環境を構築する

## 前提

dockerはインストール済みであること

## Nodeが使えるDocker環境を作成する

最初にDockerfileとdocker-compose.ymlを作成します。  
Nodeのバージョンはdocker composeからいじれるようにしています。

Dockerfile

```sh
ARG NODE_VER
FROM node:${NODE_VER}-alpine

USER node
WORKDIR /home/node/app
```

docker-compose.yml

```yml
services:
  react:
    build:
      args:
        - NODE_VER=25
      context: .
      dockerfile: Dockerfile
    tty: true
    volumes:
      - .:/home/node/app
```

buildでして無事成功したら、この節は終了です。

```sh
docker compose build
```

## Docker上でReactの環境を作成する

Docker上のReact用コンテナで、Viteプロジェクトを作成するコマンドします。

```sh
docker compose run --rm react yarn create vite
```

いくつか選択肢が提示されるので開発に合わせて適当に選択します。

```sh
docker compose run --rm react npm create vite
[+] Creating 1/1
 ✔ Network dockerreact_default  Created
Need to install the following packages:
create-vite@8.0.2
Ok to proceed? (y) y


> npx
> "create-vite"

│
◇  Project name:
│  frontend
│
◇  Select a framework:
│  React
│
◇  Select a variant:
│  TypeScript
│
◇  Use rolldown-vite (Experimental)?:
│  No
│
◇  Install with npm and start now?
│  Yes
│
◇  Scaffolding project in /home/node/app/frontend...
│
◇  Installing dependencies with npm...

added 190 packages, and audited 191 packages in 34s

47 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
│
◇  Starting dev server...

> frontend@0.0.0 dev
> vite


  VITE v7.1.12  ready in 1552 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
  ➜  press h + enter to show help
```

コンテナ内でViteベースのReactを開くための設定をvite.config.tsに追加します。

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  server: {
    host: true
  },
  plugins: [react()],
})
```

## 快適な開発のために変更：node_modulesをコンテナ内に収める

このままだとコンテナ外にnode_modulesが入っていることにより変更反映が頻繁に走るといった問題があります。  
これの解消のためにnode_modulesをコンテナ内に収める処理を入れていきます。

docker-compose.ymlに下記の変更を加えます。

- Bindマウントの先をfrontendに変更
- node_modulesをマウント
- portを接続

```yml
services:
  react:
    build:
      args:
        - NODE_VER=25
      context: .
      dockerfile: Dockerfile
    tty: true
    volumes:
      - ./frontend:/home/node/app
      - node_modules:/home/node/app/node_modules
    ports:
      - 5173:5173
volumes:
  node_modules:
```

最後にDockerfileを変更します。

```sh
ARG NODE_VER
FROM node:${NODE_VER}

USER node
WORKDIR /home/node/app

RUN mkdir node_modules

CMD ["/bin/bash", "-c", "npm install && npm run dev"]
```

## 動作確認

```sh
docker compose build
docker compose up
```

`http://localhost:5173`にアクセスして「Hello World！」と返答があれば成功です。
